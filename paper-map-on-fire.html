<link rel="import" href="../firebase-element/firebase-element.html">
<link rel="import" href="../google-map/google-map.html">

<polymer-element name="paper-map-on-fire" attributes="url centering">
    <template>
        <link rel="stylesheet" href="paper-map-on-fire.css">

        <!-- Firebase Element -->
        <firebase-element location="{{ url }}" data="{{ data }}" keys="{{ keys }}" dataready id="base"></firebase-element>
        
        <google-map longitude="{{ centering|LatLngTolongitude }}" latitude="{{ centering|LatLngTolatitude }}" id="google_map">
          <template repeat="{{x in keys | geofilter(data) }}">
              <google-map-marker longitude="{{ data[x].LatLng|LatLngTolongitude }}" latitude="{{ data[x].LatLng|LatLngTolatitude }}" title="{{data[x].value}}"></google-map-marker>
          </template>
        </google-map>
    </template>

    <script>
     //
     //globles
     //
    var map;
    var area = {
      reset: function() {
        this.bounds = new google.maps.LatLngBounds();
      },
      bounds: {},
      contains_str_latlng: function(LatLng) {
        if (LatLng !== undefined) {
          return this.contains(+LatLng.split(',')[0], +LatLng.split(',')[1]);
        }
      },
      contains: function(lat, lng) {
        var point = new google.maps.LatLng(lat, lng);
        return this.bounds.contains(point);
      },
      extend: function(lat, lng) {
        var point = new google.maps.LatLng(lat, lng);
        this.bounds.extend(point);
      }
    };
 
    var setmap = function() {
      var d = document.querySelectorAll("html /deep/ #google_map");
      map = new google.maps.Map(d[0]);
      google.maps.event.addListener(map, 'bounds_changed', function() {
        alert(map.getBounds());
      });
    };
    Polymer({
        data: null,
        keys: null,
        LatLngTolongitude: function(value) {
            return +value.split(',')[1];
        },
        LatLngTolatitude: function(value) {
            return +value.split(',')[0];
        },
        ready: function() {
          setTimeout(function() { setmap() },2000)
        },
        googleMapReady: function(attr1,attr2) {
        },
        geofilter: function(value,data) {
          if (data !== null && value !== null) {
            this.syncMap();
            var check = this.area.contains_str_latlng;
            value.forEach(function(key) {
              check(data[key].LatLng);
            });
          }
        },
        syncMap: function() {
          google.maps.event.addListener(map, 'bounds_changed', function() {
                     alert(map.getBounds());
          });
          //this.area.bounds = new google.maps.LatLngBounds( this.$.google_map.getBounds() );
        }
    });
    </script>
</polymer-element>
