<link rel="import" href="../firebase-element/firebase-element.html">
<link rel="import" href="../google-map/google-map.html">
<link rel="import" href="../google-map/google-map-search.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../core-input/core-input.html">
<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../paper-cards-on-fire/paper-cards-on-fire.html">
<link rel="import" href="../paper-filter-on-fire/paper-filter-on-fire.html">

<polymer-element id="paperMapOnFire" name="paper-map-on-fire" attributes="url location centering">
<template>
<link rel="stylesheet" href="paper-map-on-fire.css">

<!-- Firebase Element -->
<firebase-element location="{{ url }}" data="{{ data }}" keys="{{ keys }}" id="paperMapOnFireBase"></firebase-element>
<div>
  <div id="map_space"> 
    <google-map  zoom="{{ zoom }}"   latitude="{{ $.google_map_search.result.latitude }}" longitude="{{ $.google_map_search.result.longitude }}" id="google_map">
      <template repeat="{{x in pins }}">
        <google-map-marker longitude="{{ data[x].LatLng|LatLngTolongitude }}" latitude="{{ data[x].LatLng|LatLngTolatitude }}" title="{{data[x].value}}"></google-map-marker>
      </template>
    </google-map>

    <google-map-search map="{{ $.google_map.map }}" query="{{ location }}" id="google_map_search"></google-map-search>
          
  </div> 
  <div id="filters">
    <paper-filter-on-fire data="{{data}}" keys="{{$.globals.values.listings}}" filters="{{filters}}" by="facilities" filtedKeys="{{filtedKeys}}"></paper-filter-on-fire>
  </div>
  <div id="cards"> 
    <paper-cards-on-fire data="{{data}}" keys="{{filtedKeys}}" ></paper-cards-on-fire>
  </div>
</div>
</template>
<script>
  //
  //globals
  //
  var map;
  var listings;
  var area = {
    reset: function() { console.log('reset');
      area.bounds = new google.maps.LatLngBounds();
    },
    bounds: {},
    contains_str_latlng: function(LatLng) { console.log('contains_str_latlng');
      if (LatLng !== undefined) {
        return area.contains(+LatLng.split(',')[0], +LatLng.split(',')[1]);
        } else {
        return false;
      }
    },
    contains: function(lat, lng) { console.log('contains');
      var point = new google.maps.LatLng(lat, lng);
      return area.bounds.contains(point);
    },
    extend: function(lat, lng) { console.log('extend');
      var point = new google.maps.LatLng(lat, lng);
      this.bounds.extend(point);
    }
  };
  var initialize = true;
  var setmap = function() {
    var d = document.querySelectorAll("html /deep/ #google_map");
    map = d[0].map;
    //map.panControl = false;
    area.bounds = map.getBounds();
    google.maps.event.addListener(map, 'idle', function() {
      area.bounds = map.getBounds();
      var app = document.querySelectorAll("html /deep/ #paperMapOnFire")[0];
      var data = app.data;
      var keys = app.keys;
      app.pins = app.geofilter(keys,data);
    });
    initialize = false;
  };
  function redoZoom (zoom) { //map
    if (zoom) {
      } else {
      return zoom;
    }
  }    
  function hasOwnProperty(obj, prop) {
    if (obj === null) {
      return false;
    }
    var proto = obj.__proto__ || obj.constructor.prototype;
    return (prop in obj) &&
    (!(prop in proto) || proto[prop] !== obj[prop]);
  }
  Polymer({
    data: null,
    keys: null,
    filters:{},
    pins:{},
    LatLngTolongitude: function(value) { console.log('LatLngTolongitude');
      if (value !== undefined) {
        return +value.split(',')[1];
      }
    },
    LatLngTolatitude: function(value) { console.log('LatLngTolatitude');
      if (value !== undefined) {
        return +value.split(',')[0];
      }
    },
    geofilter: function(value,data) { console.log('geofilter');
      if (data !== null && value !== null) {
        if (initialize) { setmap() };
        //initialize();
        var check = area.contains_str_latlng;
        var output=[];
        value.forEach(function(key) {
          if (check(data[key].LatLng)) {
            output.push(key);
          }
        });
        return output;
      }
    },
    ready: function() { console.log('ready');
      console.log('Pins: ' + this.$.globals.values.listings);
      listings = this.$.globals.values.listings;
    }
  });
</script>
</polymer-element>
