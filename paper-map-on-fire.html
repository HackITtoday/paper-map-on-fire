<link rel="import" href="../firebase-element/firebase-element.html">
<link rel="import" href="../paper-cards-on-fire/paper-cards-on-fire.html">
<link rel="import" href="../url-value/url-value.html">
<link rel="import" href="../paper-filter-on-fire/paper-filter-on-fire.html">
<link rel="import" href="map-on-fire.html">

<polymer-element id="paperMapOnFire" name="paper-map-on-fire" attributes="url location">
<template>
<link rel="stylesheet" href="paper-map-on-fire.css">

<url-value values="{{urlValues}}"></url-value>

<firebase-element location="{{url}}" data="{{data}}" keys="{{keys}}" id="paperMapOnFireBase"></firebase-element>
<div>
  <template bind="{{x in urlValues }}">
  <h1>{{x.search}}</h1>
  </template>
  <div id="filters">
    <paper-filter-on-fire show="{{cards}}" data="{{data}}" keys="{{pins}}" filters="{{filters}}" by="facilities" filteredKeys="{{facilitiesFilteredKeys}}"></paper-filter-on-fire>

  </div>
    <div id="map_space" style="height:400px"> 
      <map-filter pins="{{pins}}"  show="{{cards}}" location="{{location}}" data="{{data}}" keys="{{keys}}" filteredKeys="{{mapFilteredKeys}}"></map-filter>
  </div> 
  <div id="cards">
    <paper-cards-on-fire data="{{data}}" keys="{{cards}}" ></paper-cards-on-fire>
  </div>
</div>
</template>
<script>
  Polymer('paper-map-on-fire',{
    publish: {
      cards: {},
      facilitiesFilteredKeys:[], 
      mapFilteredKeys: {},
      keys: {},
      urlValues:{} 
    },
    inBoth: function(a,b) {console.log('inBoth a'+a+' b'+b )
      if (a == b) {
        return a;
      }
      var output=[];
      if (b === undefined) {
        if (a === undefined) {
          return [];
          } else {
          return a;
        }
      }
      if (a === undefined) {
        if (b === undefined) {
          return [];
          } else {
          return b;
        }
      }
      if ((a.length === false || a.length === undefined) && (b.length === false || b.length === undefined)) {
        return [];
      } 
      if (b.length === false || b.length === undefined) {
        return a;
      } 
      if (a.length === false || a.length === undefined) {
        return b;
      }
      if (a.length > b.length) {
        for (var x in b) {
          if (b.indexOf(x)) {
            output.push(x);
          }
        }
        } else {
        for (var y in a) {
          if (a.indexOf(y)) {
            output.push(a[y]);
          }
        }
      }
      return output;
    },
    cards:[],
    keysChanged: function() {
      //this.cards = newValue;
      this.cards = this.inBoth(this.mapFilteredKeys,this.facilitiesFilteredKeys);
    },
    urlValuesChanged: function(oldValue, newValue) {
      if (this.urlValues) {
        this.location = this.urlValues[2];
      }
    },
    mapFilteredKeysChanged: function(oldValue, newValue) {
      this.cards = this.inBoth(newValue,this.facilitiesFilteredKeys);
    },
    facilitiesFilteredKeysChanged: function(oldValue, newValue) {
      this.cards = this.inBoth(newValue,this.mapFilteredKeys);
    },
    ready: function() { console.log('paper ready');
      if (this.urlValues) {
        this.location = this.urlValues.search;
      }
    }
  });
</script>
</polymer-element>
